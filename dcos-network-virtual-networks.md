## 虚拟网络

DC/OS使用**Overlay技术**作为IP-per-Container的解决方案。

### 术语

- 二层交换

  二层交换是工作在OSI七层协议的2层上，也就是数据链路层，而数据链路层只有MAC地址没有IP地址，无法配置静态路由（有个例外是可以在vlan上配IP）。
  
- 三层交换

  三层交换是工作在OSI七层协议的3层上，可以启用路由协议（静态或动态），还可以启用访问控制列表，总之，路由能做的事三层交换基本都能做，三层交换没有NAT。
  
- IPAM
- ARP
- VxLAN
- VTEP
- overlay

### 概述

从网络的角度来看，为了提供类似于虚拟机环境提供的最终用户体验，为每个容器提供自己的IP地址和网络命名空间是非常重要的。为容器提供隔离的网络堆栈可以确保逻辑网络隔离以及容器之间的网络性能隔离。此外，ip-per-container允许用户/开发人员使用传统的网络操作工具（traceroute，tcpdump，wireshark）和他们熟悉的应用程序，并帮助他们在调试网络连接/性能问题方面的提高生产力。从操作的角度来看，识别容器特定流量也变得更容易，从而简化了对容器的网络性能和安全策略的实施。

DC/OS的默认每容器IP解决方案需要与运行DC/OS的网络无关。因此，为了实现容器IP，需要使用虚拟网络。Overlay技术使容器网络拓扑与底层主机网络无关。此外，Overlay技术提供了容器流量与主机流量的完全隔离，使得对容器流量的策略执行更简单并且独立于主机流量。实现Overlay技术的挑战是容器发送和接收流量时封装和解封装容器流量的成本。为了最小化这些封装和拆分操作对容器网络吞吐量的影响，Overlay技术必须将封装/拆分操作作为主机操作系统内核中的数据包处理流水线的一部分。

为了实现DC/OS的容器IP解决方案，使用Overlay技术，因此需要选择Linux内核主动支持的Overlay技术。Linux内核支持的最常见的Overlay技术是**VxLAN**。

DC/OS的Overlay设计做出以下假设/约束：

- 由于集中式IPAM缺乏对可用性和可靠性的保证，方案无法使用集中的IPAM。

- 需要避免第2层的泛滥，使网络可扩展。这意味着方案不能依赖广播ARP来获取容器的MAC地址。

- 该解决方案需要支持`MesosContainerizer`和`DockerContainerizer`，即在同一个Overlay上，方案应该能够同时运行Docker和Mesos容器，并允许它们相互通信。

基于上述假设/约束，DC/OS使用基于VxLAN的第三层Overlay技术。

### 场景

下图通过数据包的流动阐述了DC/OS中基于Overlay技术实现的容器网络通信方案。

![](/assets/dcos-overlay-fig-1.png)

上图演示了一个拥有2个Agent的DC/OS集群，要让DC/OS的Overlay工作，需要一个足够大的地址空间为之上的容器分配地址。
